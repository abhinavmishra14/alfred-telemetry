plugins {
    id 'java'
    id 'eu.xenit.docker'
}
sourceCompatibility = 11

apply from: './overload.gradle'
dependencies {
    implementation "org.apache.solr:solr-core:${solrVersion}"
    implementation "org.alfresco:alfresco-search:${assVersion}"
}

createDockerFile {
    group 'docker'
    from "${solrBaseImage}"
    dependsOn(configurations.metricsGraphite)
    // overwrites existing metrics-graphite library with the one used by micrometer
    smartCopy configurations.metricsGraphite.fileCollection {
        it.group == "io.dropwizard.metrics" && it.name == "metrics-graphite"
    }, "/opt/alfresco-search-services/solr/server/lib/"
    instruction 'RUN rm -f /opt/alfresco-search-services/solr/server/lib/metrics-graphite-3.2.2.jar'

    smartCopy "${rootProject.projectDir}/integration-tests/src/test/resources/${solrFlavor}/95-init-solr-micrometer-metrics.sh", "/docker-entrypoint.d/"
    smartCopy "${rootProject.projectDir}/integration-tests/src/test/resources/${solrFlavor}/solrconfig.xml", "/opt/alfresco-search-services/solrhome/templates/rerank/conf/solrconfig.xml"
    smartCopy jar.outputs.files, "/opt/alfresco-search-services/solrhome/lib/"
}
